<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Notentraining 8888</title>
  <!-- Tone.js laden -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.37/Tone.js"></script>
  <!-- VexFlow laden -->
  <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background-color: #ffffff;
      font-family: sans-serif;
      position: relative;
      text-align: center;
    }
    /* Notensystem ‚Äì Fixiert so, dass seine Mitte immer im Mittelpunkt des Bildschirms liegt */
    #notation {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(2);
      width: 820px;
      padding: 10px;
      box-sizing: border-box;
      z-index: 1;
    }
    /* Hauptinhalt (UI) ‚Äì liegt √ºber dem Notensystem */
    #mainContent {
      position: relative;
      z-index: 10;
      opacity: 0;
      transition: opacity 1s ease-in;
      padding-bottom: 50px;
    }
    h1 {
      margin: 20px 0;
    }
    /* Linkes Men√º: Einstellungen */
    #settingsPanel {
      position: fixed;
      left: 30px;
      top: 50%;
      transform: translateY(-50%);
      background: #ffffff;
      border: 3px solid #000;
      border-radius: 20px;
      padding: 5px;
      box-sizing: border-box;
      display: inline-block;
      z-index: 10;
    }
    /* Einstellungen: Die Buttons (nur Emojis) ‚Äì minimaler Extra-Abstand */
    #settingsPanel span {
      display: block;
      cursor: pointer;
      font-size: 1.8em;
      margin: 4px 0;
      padding: 2px;
      text-align: center;
      background: none;
      border: none;
      color: #000;
      transition: background 0.2s;
    }
    #settingsPanel span:hover {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 10px;
    }
    /* Obere rechte Ecke: Score und ResponseTime */
    #topRightInfo {
      position: fixed;
      top: 10px;
      right: 10px;
      text-align: right;
      font-size: 1.2em;
      color: #000;
      z-index: 10;
    }
    /* Lage-Button: Fixiert am unteren Bildschirmrand, mittig, mit identischem Styling wie das Men√º */
    #clefTitle {
      position: fixed;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      background: #ffffff;
      border: 3px solid #000;
      border-radius: 20px;
      padding: 10px 20px;
      font-size: 1.5em;
      color: #000;
      cursor: pointer;
      z-index: 10;
      transition: all 0.5s ease;
    }
    /* Notenname-Anzeige (optional) */
    #noteNameDisplay {
      margin-top: 10px;
      font-size: 1.5em;
      color: #000;
    }
    /* Welcome Overlay */
    #welcomeOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #ffffff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #welcomeMessage {
      font-size: 2.5em;
      color: #000;
      margin-bottom: 20px;
    }
  </style>
  
  <script>
    // Globale Variablen
    var currentSeries = [];
    var seriesCounter = 0;
    var seriesLength = 5; // Level 3: 5 Noten
    var totalAttempts = 0;
    var correctAnswers = 0;
    // Level: 1 = 1 Note, 2 = 3 Noten, 3 = 5 Noten
    var level = 3;
    var selectedMode = "right"; // "left", "right" oder "both"
    var rangeArray = ["C", "D", "F", "G", "MC"];
    var currentRangeIndex = 0;
    var currentRange = rangeArray[currentRangeIndex];
    var soundEnabled = true; // Ton ist an

    // Tone.js Synthesizer
    var synth = new Tone.Synth().toDestination();

    // Objekt mit Notenarrays f√ºr die Lagen
    var rangeNotes = {
      "C": ["c", "d", "e", "f", "g"],
      "D": ["d", "e", "f#", "g", "a"],
      "F": ["f", "g", "a", "bb", "c"],
      "G": ["g", "a", "b", "c", "d"],
      "MC": ["c", "d", "e", "f", "g"]
    };

    

    // Umrechnung von MIDI Data1 in Notennamen und Oktave
    function midiNoteToName(noteNumber) {
      var noteNames = ['c','c#','d','d#','e','f','f#','g','g#','a','a#','b'];
      var octave = Math.floor(noteNumber / 12) - 1;
      var noteName = noteNames[noteNumber % 12];
      return { note: noteName, octave: octave };
    }

    // √úbergang vom Welcome Overlay zum Hauptinhalt
    function proceedToMainScreen() {
      var welcomeOverlay = document.getElementById("welcomeOverlay");
      welcomeOverlay.style.transition = "opacity 0.5s ease-out";
      welcomeOverlay.style.opacity = "0";
      setTimeout(function() {
        welcomeOverlay.style.display = "none";
        var mainContent = document.getElementById("mainContent");
        mainContent.style.transition = "opacity 1s ease-in";
        mainContent.style.opacity = "1";
      }, 500);
    }

    // Globale Funktion handleMIDIMessage ‚Äì spielt den Ton ab, wenn eine Note gespielt wird
    window.handleMIDIMessage = function(status, data1, data2) {
      console.log("handleMIDIMessage aufgerufen:", status, data1, data2);
      if (soundEnabled && status >= 144 && status < 160 && data2 > 0) {
        var midiInfo = midiNoteToName(data1);
        var pitch = midiInfo.note.toUpperCase() + midiInfo.octave;
        synth.triggerAttackRelease(pitch, "8n");
        document.getElementById("noteNameDisplay").textContent = midiInfo.note.toUpperCase() + "/" + midiInfo.octave;
      }
    };

    // Generiert eine neue Notenserie basierend auf Level, Range und Handmodus
    function generateSeries() {
      currentSeries = [];
      seriesCounter = 0;
      if (level === 1) {
        seriesLength = 1;
      } else if (level === 2) {
        seriesLength = 3;
      } else if (level === 3) {
        seriesLength = 5;
      } else if (level === "random") {
        seriesLength = Math.floor(Math.random() * 5) + 1;
      }
      var notes = rangeNotes[currentRange];
      for (var i = 0; i < seriesLength; i++) {
        var randomIndex = Math.floor(Math.random() * notes.length);
        var clef, octave;
        if (selectedMode === "left") {
          clef = "bass";
          octave = 3;
        } else if (selectedMode === "right") {
          clef = "treble";
          octave = 4;
        } else if (selectedMode === "both") {
          if (Math.random() < 0.5) {
            clef = "treble";
            octave = 4;
          } else {
            clef = "bass";
            octave = 3;
          }
        } else {
          clef = "treble";
          octave = 4;
        }
        currentSeries.push({ note: notes[randomIndex], octave: octave, clef: clef, color: "black" });
      }
      drawSeries();
    }

    function drawSeries() {
      var notationDiv = document.getElementById("notation");
      notationDiv.innerHTML = "";
      var usedWidth = 80 * seriesLength + 20;
      var renderer = new Vex.Flow.Renderer(notationDiv, Vex.Flow.Renderer.Backends.SVG);
      renderer.resize(usedWidth, 200);
      var context = renderer.getContext();
      var stave = new Vex.Flow.Stave(10, 40, usedWidth - 20);
      if (currentSeries.length > 0) {
        stave.addClef(currentSeries[0].clef).setContext(context).draw();
      }
      var staveNotes = currentSeries.map(function(item) {
        return new Vex.Flow.StaveNote({
          clef: item.clef,
          keys: [item.note + "/" + item.octave],
          duration: "q"
        }).setStyle({ fillStyle: item.color, strokeStyle: item.color });
      });
      var voice = new Vex.Flow.Voice({ num_beats: seriesLength, beat_value: 4 });
      staveNotes.forEach(function(note) { voice.addTickable(note); });
      new Vex.Flow.Formatter().joinVoices([voice]).format([voice], stave.getWidth() - 20);
      voice.draw(context, stave);
    }

    // Beim Klick auf den Lage-Button wird zur n√§chsten Lage zyklisch gewechselt
    function cycleRange() {
      currentRangeIndex = (currentRangeIndex + 1) % rangeArray.length;
      currentRange = rangeArray[currentRangeIndex];
      document.getElementById("clefTitle").textContent = currentRange + "-Lage";
      generateSeries();
    }
  </script>
</head>
<body>
  <!-- Welcome Overlay -->
  <div id="welcomeOverlay">
    <div id="welcomeMessage">Hallo, sch√∂n dich zu sehen!</div>
  </div>
  
  <!-- Hauptinhalt -->
  <div id="mainContent" style="opacity: 0;">
    <!-- Linkes Men√º: Einstellungen -->
    <div id="settingsPanel" class="expanded">
      <div id="handSettings">
        <span id="mode-left" class="inactive-mode">‚úã</span>
        <span id="mode-right" class="active-mode" style="transform: scaleX(-1);">‚úã</span>
        <span id="mode-both" class="inactive-mode">üôå</span>
      </div>
      <div id="levelSettings">
        <span id="level-1" class="inactive-level">1Ô∏è‚É£</span>
        <span id="level-2" class="inactive-level">2Ô∏è‚É£</span>
        <span id="level-3" class="active-level">3Ô∏è‚É£</span>
        <span id="level-random" class="inactive-level">üéâ</span>
      </div>
      <div id="soundSettings">
        <span id="soundToggle">üîä</span>
      </div>
    </div>
    
    <!-- Notationsbereich, fixiert in der Mitte -->
    <div id="notation"></div>
    
    <!-- Lage-Button, fixiert am unteren Bildschirmrand, mittig -->
    <div id="clefTitle" onclick="cycleRange()">C-Lage</div>
    
    <!-- Notenname-Anzeige -->
    <div id="noteNameDisplay" style="position: fixed; left: 50%; bottom: 110px; transform: translateX(-50%); font-size: 1.5em; color: #000;"></div>
    
    <!-- Debug-Ausgabe -->
    <div id="nativeLog"></div>
  </div>
  
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Automatischer √úbergang vom Welcome Overlay zum Hauptinhalt nach 3 Sekunden
      setTimeout(function() {
        proceedToMainScreen();
      }, 3000);
      
      generateSeries();
      
      // Handmodus-Buttons in settingsPanel konfigurieren
      var modeButtons = document.querySelectorAll("#handSettings span");
      modeButtons.forEach(function(btn) {
        btn.addEventListener("click", function() {
          modeButtons.forEach(function(b) {
            b.classList.remove("active-mode");
            b.classList.add("inactive-mode");
          });
          btn.classList.remove("inactive-mode");
          btn.classList.add("active-mode");
          selectedMode = btn.id.split("-")[1];
          generateSeries();
        });
      });
      
      // Level-Buttons in settingsPanel konfigurieren
      var levelButtons = document.querySelectorAll("#levelSettings span");
      levelButtons.forEach(function(btn) {
        btn.addEventListener("click", function() {
          levelButtons.forEach(function(b) {
            b.classList.remove("active-level");
            b.classList.add("inactive-level");
          });
          btn.classList.remove("inactive-level");
          btn.classList.add("active-level");
          if (btn.id === "level-1") {
            level = 1;
          } else if (btn.id === "level-2") {
            level = 2;
          } else if (btn.id === "level-3") {
            level = 3;
          } else if (btn.id === "level-random") {
            level = "random";
          }
          generateSeries();
        });
      });
      
      // Sound Toggle konfigurieren
      var soundToggle = document.getElementById("soundToggle");
      soundToggle.addEventListener("click", function() {
        soundEnabled = !soundEnabled;
        soundToggle.textContent = soundEnabled ? "üîä" : "üîá";
      });
    });
  </script>
</body>
</html>
