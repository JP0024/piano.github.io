<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Notentraining</title>
  <link rel="stylesheet" href="./style.css">
  <style>
    /* Deine bestehenden CSS-Regeln */
  </style>
</head>
<body>
  <!-- Deine bestehenden HTML-Elemente -->
  <div id="nativeLog"></div>
  
  <!-- VexFlow und andere Skripte einbinden -->
  <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
  <script>
    // Sicherstellen, dass die Funktion global verfügbar ist:
    window.handleMIDIMessage = function(status, data1, data2) {
      console.log("handleMIDIMessage aufgerufen:", status, data1, data2);
      document.getElementById("nativeLog").textContent =
         "Empfangene MIDI Nachricht: Status: " + status +
         ", Data1: " + data1 + ", Data2: " + data2;
      
      // Test: Zeige einen Alert, um zu prüfen, ob die Funktion reagiert
      // alert("MIDI empfangen!");
      
      // Wir verarbeiten nur Note-On-Nachrichten (Status 144-159 und data2 > 0)
      if (status >= 144 && status < 160 && data2 > 0) {
        const midiInfo = midiNoteToName(data1);
        processNoteInput(midiInfo.note, midiInfo.octave);
      }
    };

    // Konvertiert MIDI-Notenwert in Namen und Oktave
    function midiNoteToName(noteNumber) {
      const noteNames = ['c', 'c#', 'd', 'd#', 'e', 'f', 'f#', 'g', 'g#', 'a', 'a#', 'b'];
      let octave = Math.floor(noteNumber / 12) - 1;
      let noteName = noteNames[noteNumber % 12];
      return { note: noteName, octave: octave };
    }

    // Beispielhafte Verarbeitung der Noteingabe (angepasst an dein bestehendes System)
    function processNoteInput(inputNote, inputOctave) {
      console.log("processNoteInput:", inputNote, inputOctave);
      // Hier deine Logik, z. B.:
      totalAttempts++;
      const expected = currentSeries[seriesCounter];
      const responseTime = Date.now() - noteStartTime;
      responseTimeElem.textContent = "Response Time: " + responseTime + " ms";
      
      if (inputNote === expected.note && inputOctave === expected.octave) {
        correctAnswers++;
        expected.color = "green";
      } else {
        expected.color = "red";
      }
      updateScore();
      drawSeries();
      seriesCounter++;
      noteStartTime = Date.now();
      setTimeout(function() {
        if (seriesCounter >= seriesLength) {
          generateSeries();
        }
      }, 500);
    }

    // Hier folgen deine bisherigen Variablen, Funktionen (drawSeries, generateSeries, etc.)
    // Beispiel:
    let currentRange = "C";
    let selectedMode = "right";
    let level = 1;
    let seriesLength = 1;
    let currentSeries = [];
    let seriesCounter = 0;
    let noteStartTime = 0;
    let totalAttempts = 0;
    let correctAnswers = 0;
    
    const rangeNotes = {
      "C": ["c", "d", "e", "f", "g"],
      "D": ["d", "e", "f#", "g", "a"],
      "F": ["f", "g", "a", "bb", "c"],
      "G": ["g", "a", "b", "c", "d"],
      "MC": ["c", "d", "e", "f", "g"]
    };

    const scoreElem = document.getElementById("score");
    const responseTimeElem = document.getElementById("responseTime");
    const notationDiv = document.getElementById("notation");
    const VF = Vex.Flow;

    function drawSeries() {
      // Deine Logik zum Zeichnen der Notenserie
    }
    
    function updateScore() {
      let percent = totalAttempts > 0 ? Math.round((correctAnswers / totalAttempts) * 100) : 0;
      scoreElem.textContent = "Score: " + percent + "%";
    }
    
    function generateSeries() {
      // Deine Logik zur Serien-Generierung
    }
    
    // Initiale Generierung, etc.
    generateSeries();
  </script>
</body>
</html>
